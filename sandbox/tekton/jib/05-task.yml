apiVersion: tekton.dev/v1alpha1
kind: Task
metadata:
  name: jib-maven
spec:
  inputs:
    params:
      - name: DIRECTORY
        description: The directory containing the app, relative to the source repository root
        default: .
      - name: CACHE
        description: The name of the volume for caching Maven artifacts and base image layers
        default: m2-data
      - name: JIB_VERSION
        description: Maven JB version to be used to build the container images
        default: 2.0.0
    resources:
      - name: source
        type: git
  outputs:
    resources:
      - name: image
        type: image

  steps:
    - name: build-and-push
      image: gcr.io/cloud-builders/mvn
      command:
        - mvn
        - compile
        - com.google.cloud.tools:jib-maven-plugin:$(JIB_VERSION):build
        - -DsendCredentialsOverHttp=true
        - -Duser.home=/builder/home
        - -Djib.from.image=registry.redhat.io/redhat-openjdk-18/openjdk18-openshift
        - -Djib.allowInsecureRegistries=true
        #- -Djava.util.logging.config.file=src/main/resources/jib-log.properties
        #- -Djib.serialize=true
        #- -Djib.console=plain
        - -Djib.from.auth.username=$(RH_USERNAME)
        - -Djib.from.auth.password=$(RH_PASSWORD)
        - -Dimage=$(outputs.resources.image.url)
      env:
      - name: "DOCKER_CONFIG"
        value: "/builder/home/.docker/"
      - name: "RH_USERNAME"
        valueFrom:
          secretKeyRef:
            name: rh-account
            key: RH_USERNAME
      - name: "RH_PASSWORD"
        valueFrom:
          secretKeyRef:
            name: rh-account
            key: RH_PASSWORD
      workingDir: /workspace/source/$(inputs.params.DIRECTORY)
      volumeMounts:
        - name: $(inputs.params.CACHE)
          mountPath: /builder/home/.m2
          subPath: m2-cache
        - name: $(inputs.params.CACHE)
          mountPath: /builder/home/.cache
          subPath: jib-cache
  volumes:
  - name: m2-data
    persistentVolumeClaim:
      claimName: m2-data